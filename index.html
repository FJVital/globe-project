<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLOBE - Green Light Operations for Building Efficiency</title>
    <!-- Fixed Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5; 
            min-height: 100vh; 
            padding-top: 120px;
            font-size: 18px;
            color: black;
        }
        .header {
            background: #003333;
            color: white; 
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 1000;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sub-header {
            background: #C8C4B7;
            position: fixed;
            top: 80px;
            left: 0;
            width: 100%;
            height: 40px;
            z-index: 999;
        }
        .header-inner { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 2rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 100%;
            position: relative;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-title { 
            text-align: center;
            white-space: nowrap;
            color: white;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        .header-title .globe-text {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .header-title .subtitle-text {
            font-size: 25px;
            font-weight: 300;
        }
        .header-title .copyright-text {
            font-size: 10px;
            font-weight: 300;
        }
        .container { 
            max-width: 1200px; 
            width: 90%; 
            margin: 2rem auto; 
            padding: 2rem; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .login-card { 
            max-width: 400px; 
            margin: 4rem auto; 
            background: white; 
            padding: 2rem; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .form-group { margin-bottom: 1.2rem; }
        label { 
            display: block; 
            margin-bottom: 0.7rem; 
            font-weight: 600; 
            color: black; 
            font-size: 18px;
        }
        input, select { 
            width: 100%; 
            padding: 1rem; 
            border: 2px solid #d1d5db; 
            border-radius: 6px; 
            font-size: 18px; 
            color: black;
        }
        .btn { 
            padding: 1rem 2rem; 
            border: none; 
            border-radius: 6px; 
            font-size: 18px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .btn-primary { background: #059669; color: white; }
        .btn-primary:hover { background: #047857; }
        .btn-analyze { background: #FF6600; color: white; }
        .btn-analyze:hover { background: #E55A00; }
        .btn-corrections { background: #D40000; color: white; }
        .btn-corrections:hover { background: #B30000; }
        .btn-approve { background: #00AA00; color: white; }
        .btn-approve:hover { background: #008800; }
        .btn-pause { background: #FF6600; color: white; }
        .btn-pause:hover { background: #E55A00; }
        .btn-export { background: #6600FF; color: white; }
        .btn-export:hover { background: #5500DD; }
        .btn-integrate { background: #00FF00; color: black; }
        .btn-integrate:hover { background: #00DD00; }
        .btn-view-code { background: #FF00FF; color: white; }
        .btn-view-code:hover { background: #DD00DD; }
        .hidden { display: none !important; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .logout-btn { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 2px solid rgba(255,255,255,0.3); 
            padding: 0.7rem 1.2rem; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
        }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .stats-card { 
            background: white; 
            padding: 2rem; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .stats-number { font-size: 2.5rem; font-weight: bold; color: #059669; }
        .stats-label { font-size: 18px; color: black; margin-top: 0.5rem; }
        .tab-nav { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 1rem; }
        .tab { 
            padding: 1.5rem 2rem; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s; 
            color: black; 
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab.active { border-bottom-color: #dc2626; color: #dc2626; }
        .tab img { height: 24px; }
        .global-stats-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .global-stat-item {
            text-align: center;
        }
        .global-stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #059669;
        }
        .global-stat-label {
            font-size: 14px;
            color: black;
            margin-top: 0.3rem;
        }
        .case-list { 
            background: white; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .case-item { 
            padding: 1.5rem; 
            border-bottom: 1px solid #e5e7eb; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .case-item:hover { background: #f9fafb; }
        .case-id { font-weight: 700; color: black; font-size: 18px; }
        .case-status { 
            display: inline-block; 
            padding: 0.5rem 1rem; 
            border-radius: 12px; 
            font-size: 14px; 
            font-weight: 600; 
            margin-top: 0.7rem; 
        }
        .status-pendingreview { background: #fef3c7; color: #d97706; }
        .status-approved { background: #d1fae5; color: #059669; }
        .status-correctionsneeded { background: #fee2e2; color: #dc2626; }
        .main-content { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            padding: 2rem; 
            margin-bottom: 2rem; 
        }
        #dbStatus { 
            position: fixed; 
            top: 130px; 
            right: 20px; 
            padding: 0.7rem 1.2rem; 
            border-radius: 6px; 
            font-size: 16px; 
            font-weight: 600; 
            z-index: 1001; 
            background: #d1fae5; 
            color: #065f46; 
            border: 2px solid #a7f3d0; 
        }
        .db-connecting { background: #fef3c7 !important; color: #d97706 !important; border-color: #f3e8a8 !important; }
        .db-error { background: #fee2e2 !important; color: #dc2626 !important; border-color: #fecaca !important; }
        
        .codex-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .codex-title {
            font-size: 30px;
            color: #0000FF;
            margin-bottom: 1rem;
        }
        .codex-title .codex-text {
            font-weight: bold;
        }
        .codex-title .agent-text {
            font-weight: 300;
        }
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .config-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .config-title {
            color: #059669;
            margin-bottom: 1.5rem;
            font-size: 20px;
            font-weight: 700;
        }
        .agent-status-section {
            margin-top: 2rem;
        }
        .progress-bar {
            background: #e5e7eb;
            border-radius: 6px;
            height: 12px;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #059669, #34d399);
            border-radius: 6px;
            width: 0%;
            transition: width 0.5s ease;
        }
        .agent-log {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            border: 2px solid #e5e7eb;
        }
        .log-entry {
            margin-bottom: 0.7rem;
        }
        .button-grid {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            flex: 1;
        }
        .analysis-result {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .compliance-section {
            margin: 1rem 0;
        }
        .violation-item {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .approval-item {
            background: #d1fae5;
            border-left: 4px solid #059669;
            padding: 1rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <!-- Database Status -->
    <div id="dbStatus">üü° Connecting...</div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="header">
            <div class="header-inner">
                <div class="header-title">
                    <span class="globe-text">GLOBE</span>
                    <span class="subtitle-text">Green Light Operations for Building Efficiency</span>
                    <span class="copyright-text">¬©</span>
                </div>
            </div>
        </div>
        <div class="sub-header"></div>
        <div class="login-card">
            <h2 style="margin-bottom: 2rem; text-align: center; font-size: 24px; color: black;">Employee Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="reviewer">Reviewer</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <p style="text-align: center; margin-top: 1.5rem; font-size: 16px; color: black;">
                Demo credentials: admin/admin, reviewer/reviewer, supervisor/supervisor
            </p>
            <p style="text-align: center; margin-top: 1.5rem; font-size: 16px;">
                Are you a client? <a href="new-case.html" style="color: #059669; text-decoration: none;">Apply or check your permit here</a>
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="header">
            <div class="header-inner">
                <div class="header-title">
                    <span class="globe-text">GLOBE</span>
                    <span class="subtitle-text">Green Light Operations for Building Efficiency</span>
                    <span class="copyright-text">¬©</span>
                </div>
                <div class="user-info">
                    <span id="currentUser" style="color: white; font-size: 18px; font-weight: 600;"></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        <div class="sub-header"></div>

        <div class="container">
            <div class="dashboard-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalCases">0</div>
                    <div class="stats-label">Total Cases</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="pendingCases">0</div>
                    <div class="stats-label">Pending Review</div>
                </div>
            </div>

            <div class="tab-nav">
                <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
                <div class="tab" onclick="showTab('caseDetails')">Case Details</div>
                <div class="tab" onclick="showTab('codexAgent')">
                    <img src="codex icon.png" alt="CodeX" onerror="this.style.display='none'"/>
                    Codex Agent
                </div>
                <div class="tab" onclick="showTab('codeManagement')">Code Management</div>
            </div>

            <!-- Global Stats Bar -->
            <div class="global-stats-bar">
                <div class="global-stat-item">
                    <div class="global-stat-number" id="agentCitiesScanned">0</div>
                    <div class="global-stat-label">Cities Scanned</div>
                </div>
                <div class="global-stat-item">
                    <div class="global-stat-number" id="agentCodesFound">0</div>
                    <div class="global-stat-label">Codes Discovered</div>
                </div>
                <div class="global-stat-item">
                    <div class="global-stat-number" id="agentViolationsDetected">0</div>
                    <div class="global-stat-label">Violation Rules Created</div>
                </div>
                <div class="global-stat-item">
                    <div class="global-stat-number">100</div>
                    <div class="global-stat-label">% Accuracy</div>
                </div>
            </div>

            <div id="dashboardTab">
                <div class="main-content">
                    <h2 style="margin-bottom: 1.5rem; font-size: 24px; color: black;">Recent Cases</h2>
                    <div style="margin: 1.5rem 0;">
                        <input type="text" id="caseSearch" placeholder="Search cases..." style="width: 100%; padding: 1rem; border: 2px solid #d1d5db; border-radius: 6px; font-size: 18px;">
                    </div>
                    <div class="case-list" id="caseList">
                        <p style="text-align: center; color: black; padding: 2rem; font-size: 18px;">Loading cases...</p>
                    </div>
                </div>
            </div>

            <div id="caseDetailsTab" class="hidden">
                <div class="main-content">
                    <h2 style="font-size: 24px; color: black;">Case Details</h2>
                    <p style="font-size: 18px; color: black;">Select a case from the dashboard to view details.</p>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-analyze" onclick="alert('Select a case first')">Analyze Case</button>
                        <button class="btn btn-corrections" onclick="alert('Select a case first')" style="margin-left: 1rem;">Request Corrections</button>
                        <button class="btn btn-approve" onclick="alert('Select a case first')" style="margin-left: 1rem;">Approve</button>
                    </div>
                </div>
            </div>

            <div id="codexAgentTab" class="hidden">
                <div class="main-content">
                    <div class="codex-header">
                        <img src="codex_agent.png" alt="CodeX Agent" style="height: 200px;" onerror="this.style.display='none'"/>
                        <div style="flex: 1;">
                            <h2 class="codex-title">
                                <span class="codex-text">CodeX</span> <span class="agent-text">Intelligence Agent</span>
                            </h2>
                            <p style="font-size: 18px; color: black;">AI-powered municipal code discovery and compliance analysis system.</p>
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="config-panel">
                            <h3 class="config-title">Municipality Setup</h3>
                            <form id="agentCityForm">
                                <div class="form-group">
                                    <label for="agentCityName">City/County Name</label>
                                    <input type="text" id="agentCityName" placeholder="e.g., Chicago, Cook County" required>
                                </div>
                                <div class="form-group">
                                    <label for="agentStateCode">State</label>
                                    <select id="agentStateCode" required>
                                        <option value="">Select State</option>
                                        <option value="TX">Texas</option>
                                        <option value="CA">California</option>
                                        <option value="NY">New York</option>
                                        <option value="FL">Florida</option>
                                        <option value="IL">Illinois</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="agentWebsiteUrl">Municipal Website (Optional)</label>
                                    <input type="url" id="agentWebsiteUrl" placeholder="https://city.example.gov">
                                </div>
                                <button type="button" onclick="startAgentCodeDiscovery()" class="btn btn-primary" style="width: 100%;">
                                    Municipal Code Discovery
                                </button>
                            </form>
                        </div>

                        <div class="config-panel">
                            <h3 class="config-title">Agent Configuration</h3>
                            <div class="form-group">
                                <label for="agentUpdateFrequency">Auto-Update Frequency</label>
                                <select id="agentUpdateFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly" selected>Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="manual">Manual Only</option>
                                </select>
                            </div>

                            <div class="agent-status-section">
                                <h3 class="config-title">Agent Status</h3>
                                <div style="margin-bottom: 1rem; font-size: 18px; color: black;">
                                    <strong>Current Operation:</strong> <span id="agentCurrentOperation">Ready</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="agentProgressFill"></div>
                                </div>
                                <div style="font-size: 16px; color: black; margin-bottom: 2rem;">
                                    <span id="agentProgressText">Ready to scan municipal codes</span>
                                </div>

                                <div class="button-grid">
                                    <button onclick="pauseAgent()" class="btn btn-pause">Pause</button>
                                    <button onclick="exportAgentCodes()" class="btn btn-export">Export</button>
                                </div>
                                <button onclick="updateAgentNow()" class="btn btn-primary" style="width: 100%;">Update Codes Now</button>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem;">
                        <h3 style="color: #059669; margin-bottom: 1.5rem; font-size: 20px;">Activity Log</h3>
                        <div class="agent-log" id="agentLogContainer">
                            <div class="log-entry" style="color: #2563eb;">GLOBE Code Intelligence Agent initialized</div>
                            <div class="log-entry" style="color: #2563eb;">Connected to municipal databases</div>
                            <div class="log-entry" style="color: #059669;">Ready for code discovery operations</div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; text-align: center;">
                        <button onclick="integrateDiscoveredCodes()" class="btn btn-integrate" style="margin-right: 1rem; font-size: 18px;">
                            Integrate Discovered Codes
                        </button>
                        <button onclick="showTab('codeManagement')" class="btn btn-view-code" style="font-size: 18px;">
                            View Code Database
                        </button>
                    </div>
                </div>
            </div>

            <div id="codeManagementTab" class="hidden">
                <div class="main-content">
                    <h2 style="font-size: 24px; color: black;">Building Code Management</h2>
                    <p style="font-size: 18px; color: black;">Manage municipal building codes and compliance rules.</p>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="alert('Code management functionality ready for implementation')">Add New Code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentUserRole = null;
        let cases = [];
        let supabase = null;
        let dbConnected = false;

        // Initialize Supabase with proper error handling
        async function initializeSupabase() {
            try {
                const SUPABASE_URL = 'https://itjvhwmqhhmolumajmrh.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0anZod21xaGhtb2x1bWFqbXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMjM0NTAsImV4cCI6MjA2NjY5OTQ1MH0.ctj0ZeYLe_wk6ZNGENDtjsriUR5hfHxZUp9K67wW7MU';
                
                updateDbStatus('üü° Connecting to database...', 'db-connecting');
                
                // Wait for Supabase library to load
                let attempts = 0;
                while (typeof window.supabase === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library failed to load');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test connection
                const { data, error } = await supabase.from('cases').select('id').limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 is "table not found" which is OK for initial setup
                    throw error;
                }
                
                dbConnected = true;
                updateDbStatus('üü¢ Database Connected', '');
                console.log('‚úÖ Supabase connected successfully');
                await loadCases();
                
            } catch (error) {
                console.error('‚ùå Supabase connection failed:', error);
                dbConnected = false;
                updateDbStatus('üî¥ Using Local Storage', 'db-error');
                loadCasesFromLocalStorage();
            }
        }

        function updateDbStatus(text, className) {
            const statusEl = document.getElementById('dbStatus');
            if (statusEl) {
                statusEl.textContent = text;
                statusEl.className = className;
            }
        }

        // PDF Sealing Functions
        async function generateSealedPDF(caseData, approverName) {
            try {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([612, 792]);
                
                page.drawText('APPROVED BUILDING PLANS', {
                    x: 150,
                    y: 700,
                    size: 24,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Permit Number: ${caseData.permitNumber}`, {
                    x: 50,
                    y: 650,
                    size: 14,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Client: ${caseData.clientName}`, {
                    x: 50,
                    y: 620,
                    size: 14,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Address: ${caseData.address}`, {
                    x: 50,
                    y: 590,
                    size: 14,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                // Add approval seal
                page.drawCircle({
                    x: 450,
                    y: 500,
                    size: 80,
                    borderColor: PDFLib.rgb(0.8, 0, 0),
                    borderWidth: 5,
                    color: PDFLib.rgb(1, 0.9, 0.9)
                });
                
                page.drawText('APPROVED', {
                    x: 415,
                    y: 510,
                    size: 16,
                    color: PDFLib.rgb(0.8, 0, 0)
                });
                
                page.drawText('BUILDING DEPT', {
                    x: 405,
                    y: 490,
                    size: 12,
                    color: PDFLib.rgb(0.8, 0, 0)
                });
                
                page.drawText(`Approved by: ${approverName}`, {
                    x: 50,
                    y: 400,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Date: ${new Date().toLocaleDateString()}`, {
                    x: 50,
                    y: 380,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Time: ${new Date().toLocaleTimeString()}`, {
                    x: 50,
                    y: 360,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText('Digital Signature:', {
                    x: 50,
                    y: 300,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(approverName, {
                    x: 50,
                    y: 280,
                    size: 18,
                    color: PDFLib.rgb(0, 0, 0.8)
                });
                
                page.drawText('This document certifies that the attached plans comply with all', {
                    x: 50,
                    y: 200,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText('applicable building codes and regulations.', {
                    x: 50,
                    y: 180,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                const pdfBytes = await pdfDoc.save();
                return pdfBytes;
                
            } catch (error) {
                console.error('‚ùå Failed to generate sealed PDF:', error);
                throw error;
            }
        }

        async function downloadSealedPDF(pdfBytes, fileName) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Database operations with proper error handling
        async function saveCase(caseData) {
            if (!dbConnected || !supabase) {
                saveCaseToLocalStorage(caseData);
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('cases')
                    .insert([{
                        permit_number: caseData.permitNumber || caseData.id,
                        client_name: caseData.clientName,
                        client_email: caseData.clientEmail,
                        client_phone: caseData.clientPhone,
                        address: caseData.address,
                        permit_type: caseData.permitType,
                        description: caseData.description,
                        status: caseData.status || 'Pending Review',
                        plan_set_filename: caseData.planSet,
                        analysis_result: caseData.analysisResult || 'Initial submission received',
                        documents: caseData.documents || [],
                        revision_history: caseData.revisionHistory || []
                    }]);
                
                if (error) throw error;
                
                console.log('‚úÖ Case saved to database:', caseData.permitNumber);
                await loadCases();
                
            } catch (error) {
                console.error('‚ùå Failed to save case to database:', error);
                saveCaseToLocalStorage(caseData);
            }
        }

        async function loadCases() {
            if (!dbConnected || !supabase) {
                loadCasesFromLocalStorage();
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('cases')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                cases = data.map(row => ({
                    id: row.permit_number,
                    permitNumber: row.permit_number,
                    clientName: row.client_name,
                    clientEmail: row.client_email,
                    clientPhone: row.client_phone,
                    address: row.address,
                    permitType: row.permit_type,
                    description: row.description,
                    status: row.status,
                    submissionDate: new Date(row.created_at).toLocaleDateString(),
                    planSet: row.plan_set_filename,
                    analysisResult: row.analysis_result,
                    documents: row.documents || [],
                    revisionHistory: row.revision_history || []
                }));
                
                console.log(`‚úÖ Loaded ${cases.length} cases from database`);
                
            } catch (error) {
                console.error('‚ùå Failed to load cases from database:', error);
                loadCasesFromLocalStorage();
            }
        }

        async function updateCaseStatus(permitNumber, newStatus, analysisResult = null) {
            if (!dbConnected || !supabase) {
                updateCaseStatusInLocalStorage(permitNumber, newStatus, analysisResult);
                return;
            }
            
            try {
                const updateData = { 
                    status: newStatus,
                    updated_at: new Date().toISOString()
                };
                
                if (analysisResult) {
                    updateData.analysis_result = analysisResult;
                }
                
                const { data, error } = await supabase
                    .from('cases')
                    .update(updateData)
                    .eq('permit_number', permitNumber);
                
                if (error) throw error;
                
                console.log(`‚úÖ Updated case ${permitNumber} status to ${newStatus}`);
                await loadCases();
                
            } catch (error) {
                console.error('‚ùå Failed to update case status:', error);
                updateCaseStatusInLocalStorage(permitNumber, newStatus, analysisResult);
            }
        }

        // LocalStorage fallback functions
        function saveCaseToLocalStorage(caseData) {
            const localCases = JSON.parse(localStorage.getItem('globeCases')) || [];
            localCases.push(caseData);
            localStorage.setItem('globeCases', JSON.stringify(localCases));
            cases = localCases;
            console.log('üìÅ Case saved to localStorage');
        }

        function loadCasesFromLocalStorage() {
            cases = JSON.parse(localStorage.getItem('globeCases')) || [];
            console.log(`üìÅ Loaded ${cases.length} cases from localStorage`);
        }

        function updateCaseStatusInLocalStorage(permitNumber, newStatus, analysisResult = null) {
            const localCases = JSON.parse(localStorage.getItem('globeCases')) || [];
            const caseIndex = localCases.findIndex(c => 
                c.permitNumber === permitNumber || c.id === permitNumber
            );
            
            if (caseIndex !== -1) {
                localCases[caseIndex].status = newStatus;
                if (analysisResult) {
                    localCases[caseIndex].analysisResult = analysisResult;
                }
                localStorage.setItem('globeCases', JSON.stringify(localCases));
                cases = localCases;
                console.log(`üìÅ Updated case ${permitNumber} in localStorage`);
            }
        }

        // Application initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ GLOBE System initializing...');
            
            await initializeSupabase();
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('role').value;

                if ((username === 'admin' && password === 'admin' && role === 'admin') ||
                    (username === 'reviewer' && password === 'reviewer' && role === 'reviewer') ||
                    (username === 'supervisor' && password === 'supervisor' && role === 'supervisor')) {
                    
                    currentUser = username;
                    currentUserRole = role;
                    
                    document.getElementById('currentUser').textContent = `${username} (${role})`;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    
                    updateDashboard();
                    
                    console.log('‚úÖ Login successful:', username, role);
                } else {
                    alert('Invalid credentials. Use demo credentials provided.');
                }
            });

            document.getElementById('caseSearch').addEventListener('input', function(e) {
                filterCases(e.target.value);
            });
        });

        function logout() {
            currentUser = null;
            currentUserRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        function showTab(tabName) {
            ['dashboard', 'caseDetails', 'codeManagement', 'codexAgent'].forEach(tab => {
                document.getElementById(tab + 'Tab').classList.add('hidden');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        async function updateDashboard() {
            await loadCases();
            
            document.getElementById('totalCases').textContent = cases.length;
            document.getElementById('pendingCases').textContent = cases.filter(c => c.status === 'Pending Review').length;
            
            displayCases(cases);
        }

        function displayCases(casesToShow) {
            const caseList = document.getElementById('caseList');
            if (casesToShow.length === 0) {
                caseList.innerHTML = '<p style="text-align: center; color: black; padding: 2rem; font-size: 18px;">No cases found. Visit the <a href="new-case.html">client portal</a> to submit a case.</p>';
            } else {
                caseList.innerHTML = casesToShow.map(caseData => `
                    <div class="case-item" onclick="viewCase('${caseData.permitNumber || caseData.id}')">
                        <div class="case-id">${caseData.permitNumber || caseData.id}</div>
                        <div style="font-size: 16px; color: black; margin: 0.5rem 0;">${caseData.address} - ${caseData.description || 'No description'}</div>
                        <div class="case-status status-${(caseData.status || 'pending').replace(/\s/g, '').toLowerCase()}">${caseData.status || 'Pending Review'}</div>
                    </div>
                `).join('');
            }
        }

        function filterCases(searchTerm) {
            if (!searchTerm) {
                displayCases(cases);
                return;
            }
            
            const filtered = cases.filter(caseData => 
                (caseData.permitNumber || caseData.id || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                (caseData.clientName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                (caseData.address || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                (caseData.status || '').toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayCases(filtered);
        }

        function viewCase(caseId) {
            const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
            if (caseData) {
                showTab('caseDetails');
                const detailsTab = document.getElementById('caseDetailsTab');
                detailsTab.innerHTML = `
                    <div class="main-content">
                        <h2 style="font-size: 24px; color: black;">Case Details: ${caseData.permitNumber || caseData.id}</h2>
                        <div style="margin: 2rem 0;">
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Client:</strong> ${caseData.clientName || 'N/A'}</p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Email:</strong> ${caseData.clientEmail || 'N/A'}</p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Phone:</strong> ${caseData.clientPhone || 'N/A'}</p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Address:</strong> ${caseData.address || 'N/A'}</p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Type:</strong> ${caseData.permitType || 'N/A'}</p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Status:</strong> <span class="case-status status-${(caseData.status || 'pending').replace(/\s/g, '').toLowerCase()}">${caseData.status || 'Pending Review'}</span></p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Description:</strong> ${caseData.description || 'No description'}</p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Plan Set:</strong> ${caseData.planSet || 'No file uploaded'}</p>
                            <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Submission Date:</strong> ${caseData.submissionDate || 'N/A'}</p>
                        </div>
                        
                        ${caseData.analysisResult && caseData.analysisResult !== 'Initial submission received' ? `
                            <div class="analysis-result">
                                <h3 style="color: #0ea5e9; margin-bottom: 1rem; font-size: 20px;">AI Analysis Results</h3>
                                <div style="font-size: 16px; color: black;">${caseData.analysisResult}</div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 2rem;">
                            <button class="btn btn-analyze" onclick="analyzeCase('${caseData.permitNumber || caseData.id}')">Analyze Case</button>
                            <button class="btn btn-corrections" onclick="requestCorrections('${caseData.permitNumber || caseData.id}')" style="margin-left: 1rem;">Request Corrections</button>
                            <button class="btn btn-approve" onclick="approveCase('${caseData.permitNumber || caseData.id}')" style="margin-left: 1rem;">Approve</button>
                        </div>
                    </div>
                `;
            }
        }

        async function analyzeCase(caseId) {
            const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
            if (!caseData) return;

            const analysisResult = `
                <div class="compliance-section">
                    <h4 style="color: #059669; margin-bottom: 1rem;">üîç CodeX AI Analysis Complete</h4>
                    <div class="approval-item">
                        <strong>‚úÖ Structural Compliance:</strong> All structural elements meet building code requirements.
                    </div>
                    <div class="approval-item">
                        <strong>‚úÖ Fire Safety:</strong> Egress routes and fire safety systems properly designed.
                    </div>
                    <div class="violation-item">
                        <strong>‚ö†Ô∏è Electrical Issue:</strong> Panel location requires 3-foot clearance per NEC 110.26.
                    </div>
                    <div class="approval-item">
                        <strong>‚úÖ Plumbing:</strong> All plumbing systems comply with current codes.
                    </div>
                    <div class="approval-item">
                        <strong>‚úÖ HVAC:</strong> Mechanical systems properly sized and located.
                    </div>
                </div>
                <p style="margin-top: 1rem; font-style: italic; color: #6b7280;">
                    Analysis completed by CodeX AI Agent ‚Ä¢ ${new Date().toLocaleString()}
                </p>
            `;

            await updateCaseStatus(caseId, 'Under Review', analysisResult);
            viewCase(caseId);
            
            alert('üîç AI Analysis Complete!\n\nCodeX has analyzed the plans and generated a detailed compliance report. Review the findings above and take appropriate action.');
        }

        async function approveCase(caseId) {
            if (confirm('Approve this case and generate sealed plans?')) {
                const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
                if (!caseData) return;

                try {
                    const approverName = currentUser;
                    const sealedPdfBytes = await generateSealedPDF(caseData, approverName);
                    
                    const fileName = `APPROVED_SEALED_PLANS_${caseData.permitNumber}.pdf`;
                    await downloadSealedPDF(sealedPdfBytes, fileName);
                    
                    await updateCaseStatus(caseId, 'Approved');
                    
                    const smsMessage = `Case ${caseData.permitNumber} has been APPROVED! Your sealed plans are ready for download in the client portal.`;
                    
                    alert(`‚úÖ Case Approved Successfully!\n\nüìã Sealed plans generated: ${fileName}\nüì± SMS sent to ${caseData.clientPhone}:\n"${smsMessage}"\n\nüîó Client can download sealed plans from the client portal.`);
                    
                    updateDashboard();
                    viewCase(caseId);
                    
                } catch (error) {
                    console.error('‚ùå Failed to approve case:', error);
                    alert('‚ùå Failed to generate sealed plans. Please try again.');
                }
            }
        }

        async function requestCorrections(caseId) {
            const corrections = prompt('Enter specific corrections needed:');
            if (corrections) {
                const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
                if (!caseData) return;

                await updateCaseStatus(caseId, 'Corrections Needed');
                
                const smsMessage = `Case ${caseData.permitNumber} requires corrections. Please check the client portal for details.`;
                
                alert(`üìù Correction Request Sent!\n\nüì± SMS sent to ${caseData.clientPhone}:\n"${smsMessage}"\n\nüìß Email sent to ${caseData.clientEmail} with correction details:\n"${corrections}"\n\nüîó Client will submit revised plans through the client portal.`);
                
                updateDashboard();
                viewCase(caseId);
            }
        }

        // Codex Agent Functions
        let agentIsScanning = false;
        let agentProgress = 0;
        let agentCitiesScannedCount = 0;
        let agentCodesFoundCount = 0;
        let agentViolationsDetectedCount = 0;

        function startAgentCodeDiscovery() {
            const cityName = document.getElementById('agentCityName').value;
            const stateCode = document.getElementById('agentStateCode').value;
            
            if (!cityName || !stateCode) {
                alert('Please fill in City/County Name and State to launch discovery!');
                return;
            }

            if (agentIsScanning) {
                addAgentLogEntry('warning', 'Agent is already scanning. Please wait or pause.');
                return;
            }

            agentIsScanning = true;
            agentProgress = 0;
            document.getElementById('agentCurrentOperation').textContent = `Scanning ${cityName}, ${stateCode}`;
            addAgentLogEntry('info', `Initiating code discovery for ${cityName}, ${stateCode}`);
            
            simulateAgentCodeDiscovery(cityName, stateCode);
        }

        function simulateAgentCodeDiscovery(cityName, stateCode) {
            const steps = [
                { progress: 15, text: 'Connecting to Municode library...', log: 'Connected to 3,300+ municipal codes' },
                { progress: 30, text: 'Scanning city website...', log: `Found ${cityName} municipal website` },
                { progress: 50, text: 'Extracting PDF documents...', log: 'Processing 47 code documents' },
                { progress: 70, text: 'Parsing building codes...', log: 'Discovering new building codes...' },
                { progress: 85, text: 'Creating AI compliance rules...', log: 'Generating violation detection rules...' },
                { progress: 100, text: 'Code discovery complete!', log: `Successfully integrated ${cityName} codes into GLOBE` }
            ];
            let currentStep = 0;

            const processStep = () => {
                if (currentStep < steps.length && agentIsScanning) {
                    const step = steps[currentStep];
                    agentProgress = step.progress;

                    document.getElementById('agentProgressFill').style.width = agentProgress + '%';
                    document.getElementById('agentProgressText').textContent = step.text;
                    addAgentLogEntry('info', step.log);

                    if (step.progress === 100) {
                        agentCitiesScannedCount++;
                        agentCodesFoundCount += 3;
                        agentViolationsDetectedCount += 9;
                        updateAgentStats();
                        agentIsScanning = false;
                        document.getElementById('agentCurrentOperation').textContent = 'Discovery Complete';
                        addAgentLogEntry('success', `Discovery for ${cityName}, ${stateCode} finished. Total codes: ${agentCodesFoundCount}`);
                    }

                    currentStep++;
                    setTimeout(processStep, 2000);
                } else if (!agentIsScanning && currentStep < steps.length) {
                    addAgentLogEntry('info', 'Agent operation suspended.');
                }
            };

            processStep();
        }

        function addAgentLogEntry(type, message) {
            const logContainer = document.getElementById('agentLogContainer');
            if (!logContainer) return;

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            const colors = {
                'info': '#2563eb',
                'success': '#059669',
                'warning': '#d97706',
                'error': '#dc2626'
            };
            logEntry.style.color = colors[type] || '#2563eb';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateAgentStats() {
            document.getElementById('agentCitiesScanned').textContent = agentCitiesScannedCount;
            document.getElementById('agentCodesFound').textContent = agentCodesFoundCount;
            document.getElementById('agentViolationsDetected').textContent = agentViolationsDetectedCount;
        }

        function pauseAgent() {
            if (agentIsScanning) {
                agentIsScanning = false;
                addAgentLogEntry('warning', 'Agent paused by user');
                document.getElementById('agentCurrentOperation').textContent = 'Paused';
            } else {
                addAgentLogEntry('info', 'Agent is not active to pause.');
            }
        }

        function exportAgentCodes() {
            addAgentLogEntry('info', 'Exporting discovered codes to GLOBE database...');
            setTimeout(() => {
                addAgentLogEntry('success', 'Code database exported successfully');
                alert('Code database exported as JSON file.');
            }, 1000);
        }

        function integrateDiscoveredCodes() {
            addAgentLogEntry('info', 'Integrating codes into main GLOBE system...');
            setTimeout(() => {
                addAgentLogEntry('success', 'All discovered codes integrated into GLOBE database');
                addAgentLogEntry('info', 'Code compliance rules activated');
                alert('Success! Discovered codes have been integrated into GLOBE. Check the Code Management tab to see all imported codes.');
            }, 1500);
        }

        function updateAgentNow() {
            if (agentIsScanning) {
                addAgentLogEntry('warning', 'Agent is currently busy. Please wait or pause the current operation.');
                return;
            }
            addAgentLogEntry('info', 'Initiating manual code update check...');
            agentIsScanning = true;
            agentProgress = 0;
            document.getElementById('agentCurrentOperation').textContent = 'Checking for updates...';
            document.getElementById('agentProgressFill').style.width = '0%';
            document.getElementById('agentProgressText').textContent = 'Checking for updates...';

            setTimeout(() => {
                agentProgress = 50;
                document.getElementById('agentProgressFill').style.width = '50%';
                document.getElementById('agentProgressText').textContent = 'Comparing against online sources...';
                addAgentLogEntry('info', 'Comparing current database with latest municipal code versions.');
            }, 1000);

            setTimeout(() => {
                agentProgress = 100;
                document.getElementById('agentProgressFill').style.width = '100%';
                document.getElementById('agentCurrentOperation').textContent = 'Update Complete';
                agentIsScanning = false;

                const newCodesFound = Math.floor(Math.random() * 3);
                if (newCodesFound > 0) {
                    addAgentLogEntry('success', `Found ${newCodesFound} new or updated codes.`);
                    agentCodesFoundCount += newCodesFound;
                    agentViolationsDetectedCount += newCodesFound * 3;
                    updateAgentStats();
                } else {
                    addAgentLogEntry('info', 'No new code updates found at this time.');
                }
                document.getElementById('agentProgressText').textContent = 'Update check complete.';
            }, 2500);
        }

        // Expose functions globally
        window.logout = logout;
        window.showTab = showTab;
        window.viewCase = viewCase;
        window.analyzeCase = analyzeCase;
        window.approveCase = approveCase;
        window.requestCorrections = requestCorrections;
        window.startAgentCodeDiscovery = startAgentCodeDiscovery;
        window.pauseAgent = pauseAgent;
        window.exportAgentCodes = exportAgentCodes;
        window.integrateDiscoveredCodes = integrateDiscoveredCodes;
        window.updateAgentNow = updateAgentNow;
        window.saveCase = saveCase;
        
        console.log('‚úÖ GLOBE System Initialized Successfully');
        console.log('üî• PDF Sealing System Ready');
        console.log('üöÄ All core functionality working');
    </script>
</body>
</html>
                    