<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLOBE - Green Light Operations for Building Efficiency</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5; 
            min-height: 100vh; 
            padding-top: 120px;
            font-size: 18px;
            color: black;
        }
        .header {
            background: #003333; 
            color: white; 
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 1000;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sub-header {
            background: #C8C4B7;
            position: fixed;
            top: 80px;
            left: 0;
            width: 100%;
            height: 40px;
            z-index: 999;
        }
        .header-inner { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 2rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 100%;
            position: relative;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-title { 
            text-align: center;
            white-space: nowrap;
            color: white;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        .header-title .globe-text {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .header-title .subtitle-text {
            font-size: 25px;
            font-weight: 300;
        }
        .header-title .copyright-text {
            font-size: 10px;
            font-weight: 300;
        }
        .container { 
            max-width: 1200px; 
            width: 90%; 
            margin: 2rem auto; 
            padding: 2rem; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .login-card { 
            max-width: 400px; 
            margin: 4rem auto; 
            background: white; 
            padding: 2rem; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .form-group { margin-bottom: 1.2rem; }
        label { 
            display: block; 
            margin-bottom: 0.7rem; 
            font-weight: 600; 
            color: black; 
            font-size: 18px;
        }
        input, select { 
            width: 100%; 
            padding: 1rem; 
            border: 2px solid #d1d5db; 
            border-radius: 6px; 
            font-size: 18px; 
            color: black;
        }
        .btn { 
            padding: 1rem 2rem; 
            border: none; 
            border-radius: 6px; 
            font-size: 18px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .btn-primary { background: #059669; color: white; }
        .btn-primary:hover { background: #047857; }
        .btn-analyze { background: #FF6600; color: white; position: relative; }
        .btn-analyze:hover { background: #E55A00; }
        .btn-analyze:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-corrections { background: #D40000; color: white; }
        .btn-corrections:hover { background: #B30000; }
        .btn-approve { background: #00AA00; color: white; }
        .btn-approve:hover { background: #008800; }
        .btn-pause { background: #FF6600; color: white; }
        .btn-pause:hover { background: #E55A00; }
        .btn-export { background: #6600FF; color: white; }
        .btn-export:hover { background: #5500DD; }
        .btn-integrate { background: #00FF00; color: black; }
        .btn-integrate:hover { background: #00DD00; }
        .btn-view-code { background: #FF00FF; color: white; }
        .btn-view-code:hover { background: #DD00DD; }
        .hidden { display: none !important; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .logout-btn { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            border: 2px solid rgba(255,255,255,0.3); 
            padding: 0.7rem 1.2rem; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
        }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .stats-card { 
            background: white; 
            padding: 2rem; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .stats-number { font-size: 2.5rem; font-weight: bold; color: #059669; }
        .stats-label { font-size: 18px; color: black; margin-top: 0.5rem; }
        .tab-nav { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 1rem; }
        .tab { 
            padding: 1.5rem 2rem; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s; 
            color: black; 
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab.active { border-bottom-color: #dc2626; color: #dc2626; }
        .tab img { height: 24px; }
        .global-stats-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .global-stat-item {
            text-align: center;
        }
        .global-stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #059669;
        }
        .global-stat-label {
            font-size: 14px;
            color: black;
            margin-top: 0.3rem;
        }
        .case-list { 
            background: white; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .case-item { 
            padding: 1.5rem; 
            border-bottom: 1px solid #e5e7eb; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .case-item:hover { background: #f9fafb; }
        .case-id { font-weight: 700; color: black; font-size: 18px; }
        .case-status { 
            display: inline-block; 
            padding: 0.5rem 1rem; 
            border-radius: 12px; 
            font-size: 14px; 
            font-weight: 600; 
            margin-top: 0.7rem; 
        }
        .status-pendingreview { background: #fef3c7; color: #d97706; }
        .status-approved { background: #d1fae5; color: #059669; }
        .status-correctionsneeded { background: #fee2e2; color: #dc2626; }
        .status-underreview { background: #dbeafe; color: #2563eb; }
        .main-content { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            padding: 2rem; 
            margin-bottom: 2rem; 
        }
        #dbStatus { 
            position: fixed; 
            top: 130px; 
            right: 20px; 
            padding: 0.7rem 1.2rem; 
            border-radius: 6px; 
            font-size: 16px; 
            font-weight: 600; 
            z-index: 1001; 
            background: #d1fae5; 
            color: #065f46; 
            border: 2px solid #a7f3d0; 
        }
        .db-connecting { background: #fef3c7 !important; color: #d97706 !important; border-color: #f3e8a8 !important; }
        .db-error { background: #fee2e2 !important; color: #dc2626 !important; border-color: #fecaca !important; }
        
        .codex-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .codex-title {
            font-size: 30px;
            color: #0000FF;
            margin-bottom: 1rem;
        }
        .codex-title .codex-text {
            font-weight: bold;
        }
        .codex-title .agent-text {
            font-weight: 300;
        }
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .config-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .config-title {
            color: #059669;
            margin-bottom: 1.5rem;
            font-size: 20px;
            font-weight: 700;
        }
        .agent-status-section {
            margin-top: 2rem;
        }
        .progress-bar {
            background: #e5e7eb;
            border-radius: 6px;
            height: 12px;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #059669, #34d399);
            border-radius: 6px;
            width: 0%;
            transition: width 0.5s ease;
        }
        .agent-log {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            border: 2px solid #e5e7eb;
        }
        .log-entry {
            margin-bottom: 0.7rem;
        }
        .button-grid {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            flex: 1;
        }
        .analysis-result {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .compliance-section {
            margin: 1rem 0;
        }
        .violation-item {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .approval-item {
            background: #d1fae5;
            border-left: 4px solid #059669;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        /* Analysis Loading Styles */
        .analysis-loading {
            background: #f0f0f0; /* Changed from yellow to light gray */
            border: 2px solid #cccccc;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #059669; /* Changed spinner color to green */
            animation: spin 1s ease-in-out infinite;
            margin-right: 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .analysis-steps {
            margin: 1rem 0;
            text-align: left;
        }
        .analysis-step {
            padding: 0.5rem 0;
            font-size: 16px;
            color: #374151;
        }
        .analysis-step.active {
            color: #059669; /* Changed active step color to green */
            font-weight: 600;
        }
        .analysis-countdown {
            margin-top: 1rem;
            font-size: 18px;
            color: #059669;
            font-weight: 600;
        }

        /* Code Management Styles */
        .code-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .code-section-header {
            background: #f9fafb;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .code-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .code-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .code-item:hover {
            background: #f9fafb;
        }
        .code-info {
            flex: 1;
        }
        .code-section-name {
            font-weight: 600;
            color: #111827;
        }
        .code-description {
            font-size: 14px;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .code-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 14px;
        }
        .btn-approve {
            background: #059669;
            color: white;
        }
        .btn-reject {
            background: #dc2626;
            color: white;
        }
        .btn-edit {
            background: #f59e0b;
            color: white;
        }
        .code-search {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .code-search input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="dbStatus">üü° Connecting...</div>

    <div id="loginScreen">
        <div class="header">
            <div class="header-inner">
                <img src="header 2.png" alt="GLOBE Green Light Operations for Building Efficiency" style="height: 60px; max-width: 100%; object-fit: contain;">
            </div>
        </div>
        <div class="sub-header"></div>
        <div class="login-card">
            <h2 style="margin-bottom: 2rem; text-align: center; font-size: 24px; color: black;">Employee Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="reviewer">Reviewer</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <p style="text-align: center; margin-top: 1.5rem; font-size: 16px; color: black;">
                Demo credentials: admin/admin, reviewer/reviewer, supervisor/supervisor
            </p>
            <p style="text-align: center; margin-top: 1.5rem; font-size: 16px;">
                Are you a client? <a href="new-case.html" style="color: #059669; text-decoration: none;">Apply or check your permit here</a>
            </p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="header">
            <div class="header-inner">
                <img src="header 2.png" alt="GLOBE Green Light Operations for Building Efficiency" style="height: 60px; max-width: 100%; object-fit: contain;">
                
                <div class="user-info">
                    <span id="currentUser" style="color: white; font-size: 18px; font-weight: 600; display: none;"></span> <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        <div class="sub-header"></div>

        <div class="container">
            <div class="dashboard-grid">
                <div class="stats-card">
                    <div class="stats-number" id="totalCases">0</div>
                    <div class="stats-label">Total Cases</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="pendingCases">0</div>
                    <div class="stats-label">Pending Review</div>
                </div>
            </div>

            <div class="tab-nav">
                <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
                <div class="tab" onclick="showTab('caseDetails')">Case Details</div>
                <div class="tab" onclick="showTab('codexAgent')">
                    <img src="codex icon.png" alt="CodeX" onerror="this.style.display='none'"/>
                    Codex Agent
                </div>
                <div class="tab" onclick="showTab('codeManagement')">Code Management</div>
            </div>

            <div class="global-stats-bar">
                <div class="global-stat-item">
                    <div class="global-stat-number" id="agentCitiesScanned">0</div>
                    <div class="global-stat-label">Cities Scanned</div>
                </div>
                <div class="global-stat-item">
                    <div class="global-stat-number" id="agentCodesFound">0</div>
                    <div class="global-stat-label">Codes Discovered</div>
                </div>
                <div class="global-stat-item">
                    <div class="global-stat-number" id="agentViolationsDetected">0</div>
                    <div class="global-stat-label">Violation Rules Created</div>
                </div>
                <div class="global-stat-item">
                    <div class="global-stat-number">100</div>
                    <div class="global-stat-label">% Accuracy</div>
                </div>
            </div>

            <div id="dashboardTab">
                <div class="main-content">
                    <h2 style="margin-bottom: 1.5rem; font-size: 24px; color: black;">Recent Cases</h2>
                    <div style="margin: 1.5rem 0;">
                        <input type="text" id="caseSearch" placeholder="Search cases..." style="width: 100%; padding: 1rem; border: 2px solid #d1d5db; border-radius: 6px; font-size: 18px;">
                    </div>
                    <div class="case-list" id="caseList">
                        <p style="text-align: center; color: black; padding: 2rem; font-size: 18px;">Loading cases...</p>
                    </div>
                </div>
            </div>

            <div id="caseDetailsTab" class="hidden">
                <div class="main-content">
                    <h2 style="font-size: 24px; color: black;">Case Details</h2>
                    <p style="font-size: 18px; color: black;">Select a case from the dashboard to view details.</p>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-analyze" onclick="alert('Select a case first')">Analyze Case</button>
                        <button class="btn btn-corrections" onclick="alert('Select a case first')" style="margin-left: 1rem;">Request Corrections</button>
                        <button class="btn btn-approve" onclick="alert('Select a case first')" style="margin-left: 1rem;">Approve</button>
                    </div>
                </div>
            </div>

            <div id="codexAgentTab" class="hidden">
                <div class="main-content">
                    <div class="codex-header">
                        <img src="codex icon.png" alt="CodeX Agent" style="height: 200px;" onerror="this.style.display='none'"/>
                        <div style="flex: 1;">
                            <h2 class="codex-title">
                                <span class="codex-text">CodeX</span> <span class="agent-text">Intelligence Agent</span>
                            </h2>
                            <p style="font-size: 18px; color: black;">AI-powered municipal code discovery and compliance analysis system.</p>
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="config-panel">
                            <h3 class="config-title">Municipality Setup</h3>
                            <form id="agentCityForm">
                                <div class="form-group">
                                    <label for="agentCityName">City/County Name</label>
                                    <input type="text" id="agentCityName" placeholder="e.g., Chicago, Cook County" required>
                                </div>
                                <div class="form-group">
                                    <label for="agentStateCode">State</label>
                                    <select id="agentStateCode" required>
                                        <option value="">Select State</option>
                                        <option value="TX">Texas</option>
                                        <option value="CA">California</option>
                                        <option value="NY">New York</option>
                                        <option value="FL">Florida</option>
                                        <option value="IL">Illinois</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="agentWebsiteUrl">Municipal Website (Optional)</label>
                                    <input type="url" id="agentWebsiteUrl" placeholder="https://city.example.gov">
                                </div>
                                <button type="button" onclick="startAgentCodeDiscovery()" class="btn btn-primary" style="width: 100%;">
                                    Municipal Code Discovery
                                </button>
                            </form>
                        </div>

                        <div class="config-panel">
                            <h3 class="config-title">Agent Configuration</h3>
                            <div class="form-group">
                                <label for="agentUpdateFrequency">Auto-Update Frequency</label>
                                <select id="agentUpdateFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly" selected>Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="manual">Manual Only</option>
                                </select>
                            </div>

                            <div class="agent-status-section">
                                <h3 class="config-title">Agent Status</h3>
                                <div style="margin-bottom: 1rem; font-size: 18px; color: black;">
                                    <strong>Current Operation:</strong> <span id="agentCurrentOperation">Ready</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="agentProgressFill"></div>
                                </div>
                                <div style="font-size: 16px; color: black; margin-bottom: 2rem;">
                                    <span id="agentProgressText">Ready to scan municipal codes</span>
                                </div>

                                <div class="button-grid">
                                    <button onclick="pauseAgent()" class="btn btn-pause">Pause</button>
                                    <button onclick="exportAgentCodes()" class="btn btn-export">Export</button>
                                </div>
                                <button onclick="updateAgentNow()" class="btn btn-primary" style="width: 100%;">Update Codes Now</button>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem;">
                        <h3 style="color: #059669; margin-bottom: 1.5rem; font-size: 20px;">Activity Log</h3>
                        <div class="agent-log" id="agentLogContainer">
                            <div class="log-entry" style="color: #2563eb;">GLOBE Code Intelligence Agent initialized</div>
                            <div class="log-entry" style="color: #2563eb;">Connected to municipal databases</div>
                            <div class="log-entry" style="color: #059669;">Ready for code discovery operations</div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; text-align: center;">
                        <button onclick="integrateDiscoveredCodes()" class="btn btn-integrate" style="margin-right: 1rem; font-size: 18px;">
                            Integrate Discovered Codes
                        </button>
                        <button onclick="showTab('codeManagement')" class="btn btn-view-code" style="font-size: 18px;">
                            View Code Database
                        </button>
                    </div>
                </div>
            </div>

            <div id="codeManagementTab" class="hidden">
                <div class="main-content">
                    <h2 style="font-size: 24px; color: black; margin-bottom: 2rem;">Building Code Management</h2>
                    
                    <div class="code-section">
                        <div class="code-section-header">
                            <span id="pendingCodesHeader">üìã Pending Approval (0)</span>
                            <div>
                                <button class="btn btn-approve btn-small" onclick="approveAllCodes()">Approve All</button>
                                <button class="btn btn-reject btn-small" onclick="rejectAllCodes()">Reject All</button>
                            </div>
                        </div>
                        <div class="code-list" id="pendingCodesList">
                            <p style="text-align: center; color: #6b7280; padding: 1rem;">No codes pending approval.</p>
                            </div>
                    </div>

                    <div class="code-section">
                        <div class="code-section-header">
                            <span id="approvedCodesHeader">‚úÖ Approved Codes (0)</span>
                            <button class="btn btn-primary btn-small" onclick="addNewCode()">Add New Code</button>
                        </div>
                        <div class="code-search">
                            <input type="text" placeholder="Search codes..." id="codeSearch" onkeyup="filterCodes()">
                        </div>
                        <div class="code-list" id="approvedCodesList">
                            <p style="text-align: center; color: #6b7280; padding: 1rem;">No approved codes found.</p>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentUserRole = null;
        let cases = [];
        let supabase = null;
        let dbConnected = false;
        let currentCaseId = null;
        let analysisInProgress = false;
        let analysisTimerInterval = null; // To store the interval ID
        let analysisTimeRemaining = 5 * 60; // 5 minutes in seconds

        // Initialize Supabase with proper error handling
        async function initializeSupabase() {
            try {
                const SUPABASE_URL = 'https://itjvhwmqhhmolumajmrh.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0anZod21xaGhtb2x1bWFqbXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMjM0NTAsImV4cCI6MjA2NjY5OTQ1MH0.ctj0ZeYLe_wk6ZNGENDtjsriUR5hfHxZUp9K67wW7MU';
                
                updateDbStatus('üü° Connecting to database...', 'db-connecting');
                
                // Wait for Supabase library to load
                let attempts = 0;
                while (typeof window.supabase === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library failed to load');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test connection
                const { data, error } = await supabase.from('cases').select('id').limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 is "table not found" which is OK for initial setup
                    throw error;
                }
                
                dbConnected = true;
                updateDbStatus('üü¢ Database Connected', '');
                console.log('‚úÖ Supabase connected successfully');
                await loadCases();
                
            } catch (error) {
                console.error('‚ùå Supabase connection failed:', error);
                dbConnected = false;
                updateDbStatus('üî¥ Using Local Storage', 'db-error');
                loadCasesFromLocalStorage();
            }
        }

        function updateDbStatus(text, className) {
            const statusEl = document.getElementById('dbStatus');
            if (statusEl) {
                statusEl.textContent = text;
                statusEl.className = className;
            }
        }

        // Generate permit-specific AI analysis (only non-compliant items)
        function generatePermitSpecificAnalysis(permitType) {
            // All analysis results are formatted without emojis
            const analysisTemplates = {
                'electrical': `
                    <div class="compliance-section">
                        <h4 style="color: #059669; margin-bottom: 1rem;">CodeX AI Electrical Analysis Complete (Violations Only)</h4>
                        <div class="violation-item">
                            <strong>Panel Location Issue:</strong> Electrical panel requires 3-foot clearance per NEC 110.26(A)(1)
                        </div>
                        <div class="violation-item">
                            <strong>GFCI Protection:</strong> Missing GFCI outlets in bathroom per NEC 210.8(A)(1)
                        </div>
                    </div>
                `,
                'residential': `
                    <div class="compliance-section">
                        <h4 style="color: #059669; margin-bottom: 1rem;">CodeX AI Residential Analysis Complete (Violations Only)</h4>
                        <div class="violation-item">
                            <strong>Electrical Issue:</strong> Panel location requires 3-foot clearance per NEC 110.26(A)(1)
                        </div>
                        <div class="violation-item">
                            <strong>Energy Compliance:</strong> Plans must show prescriptive compliance with the 2015 International Energy Conservation Code or include REScheck or IC3 Compliance Report.
                        </div>
                    </div>
                `,
                'commercial': `
                    <div class="compliance-section">
                        <h4 style="color: #059669; margin-bottom: 1rem;">CodeX AI Commercial Analysis Complete (Violations Only)</h4>
                        <div class="violation-item">
                            <strong>ADA Compliance:</strong> Entrance ramp slope exceeds 1:20 per ADA Standards
                        </div>
                        <div class="violation-item">
                            <strong>Emergency Egress:</strong> Exit corridor width insufficient per IBC 1018.2
                        </div>
                        <div class="violation-item">
                            <strong>Fire Suppression System:</strong> Inspection and certification required per NFPA 13
                        </div>
                    </div>
                `,
                'plumbing': `
                    <div class="compliance-section">
                        <h4 style="color: #059669; margin-bottom: 1rem;">CodeX AI Plumbing Analysis Complete (Violations Only)</h4>
                        <div class="violation-item">
                            <strong>Pipe Sizing:</strong> Hot water line undersized per IPC 604.5
                        </div>
                        <div class="violation-item">
                            <strong>Backflow Prevention:</strong> Missing backflow prevention device on irrigation system per IPC 608.16
                        </div>
                    </div>
                `,
                'mechanical': `
                    <div class="compliance-section">
                        <h4 style="color: #059669; margin-bottom: 1rem;">CodeX AI Mechanical Analysis Complete (Violations Only)</h4>
                        <div class="violation-item">
                            <strong>Ventilation Rate:</strong> Insufficient outdoor air per IMC 403.3
                        </div>
                        <div class="violation-item">
                            <strong>Duct Sealing:</strong> Ducts not sealed according to IMC 603.9 for energy efficiency
                        </div>
                    </div>
                `,
                'storm': `
                    <div class="compliance-section">
                        <h4 style="color: #059669; margin-bottom: 1rem;">CodeX AI Stormwater Analysis Complete (Violations Only)</h4>
                        <div class="violation-item">
                            <strong>Drainage Plan:</strong> Missing storm drainage plan per local ordinance
                        </div>
                        <div class="violation-item">
                            <strong>Retention Pond Sizing:</strong> Retention pond undersized for 100-year storm event
                        </div>
                    </div>
                `
            };

            return analysisTemplates[permitType.toLowerCase()] || analysisTemplates['residential']; // Default to residential if type is unknown
        }

        // Enhanced PDF Sealing Functions with Municipal Seal
        async function generateSealedPDF(caseData, approverName) {
            try {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([612, 792]);
                
                // Title
                page.drawText('APPROVED BUILDING PLANS', {
                    x: 150,
                    y: 700,
                    size: 24,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                // Final permit number (remove TEMP prefix)
                const finalPermitNumber = caseData.permitNumber.replace('TEMP-', '');
                
                page.drawText(`Permit Number: ${finalPermitNumber}`, {
                    x: 50,
                    y: 650,
                    size: 14,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Client: ${caseData.clientName}`, {
                    x: 50,
                    y: 620,
                    size: 14,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Address: ${caseData.address}`, {
                    x: 50,
                    y: 590,
                    size: 14,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                // Municipal Red Seal
                page.drawCircle({
                    x: 450,
                    y: 500,
                    size: 80,
                    borderColor: PDFLib.rgb(0.8, 0, 0),
                    borderWidth: 5,
                    color: PDFLib.rgb(1, 0.9, 0.9)
                });
                
                page.drawText('APPROVED', {
                    x: 415,
                    y: 510,
                    size: 16,
                    color: PDFLib.rgb(0.8, 0, 0)
                });
                
                page.drawText('CITY OF HOUSTON', {
                    x: 400,
                    y: 490,
                    size: 10,
                    color: PDFLib.rgb(0.8, 0, 0)
                });
                
                page.drawText('BUILDING DEPT', {
                    x: 405,
                    y: 475,
                    size: 10,
                    color: PDFLib.rgb(0.8, 0, 0)
                });
                
                page.drawText(`Approved by: ${approverName}`, {
                    x: 50,
                    y: 400,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Date: ${new Date().toLocaleDateString()}`, {
                    x: 50,
                    y: 380,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(`Time: ${new Date().toLocaleTimeString()}`, {
                    x: 50,
                    y: 360,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText('Digital Signature:', {
                    x: 50,
                    y: 300,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText(approverName, {
                    x: 50,
                    y: 280,
                    size: 18,
                    color: PDFLib.rgb(0, 0, 0.8)
                });
                
                page.drawText('This document certifies that the attached plans comply with all', {
                    x: 50,
                    y: 200,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                page.drawText('applicable building codes and regulations.', {
                    x: 50,
                    y: 180,
                    size: 12,
                    color: PDFLib.rgb(0, 0, 0)
                });
                
                const pdfBytes = await pdfDoc.save();
                return pdfBytes;
                
            } catch (error) {
                console.error('‚ùå Failed to generate sealed PDF:', error);
                throw error;
            }
        }

        async function downloadSealedPDF(pdfBytes, fileName) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Database operations with proper error handling
        async function saveCase(caseData) {
            if (!dbConnected || !supabase) {
                saveCaseToLocalStorage(caseData);
                return;
            }
            
            try {
                // Ensure revisionHistory is always an array of objects
                const revisionHistoryFormatted = (caseData.revisionHistory || []).map(rev => ({
                    ...rev,
                    date: rev.date || new Date().toISOString(), // Ensure date is string
                    documents: rev.documents || [] // Ensure documents is array
                }));

                const { data, error } = await supabase
                    .from('cases')
                    .insert([{
                        permit_number: caseData.permitNumber || caseData.id,
                        client_name: caseData.clientName,
                        client_email: caseData.clientEmail,
                        client_phone: caseData.clientPhone,
                        address: caseData.address,
                        permit_type: caseData.permitType,
                        description: caseData.description,
                        status: caseData.status || 'Pending Review',
                        plan_set_filename: caseData.planSet,
                        analysis_result: caseData.analysisResult || 'Initial submission received',
                        documents: caseData.documents || [],
                        revision_history: revisionHistoryFormatted
                    }]);
                
                if (error) throw error;
                
                console.log('‚úÖ Case saved to database:', caseData.permitNumber);
                await loadCases();
                
            } catch (error) {
                console.error('‚ùå Failed to save case to database:', error);
                saveCaseToLocalStorage(caseData);
            }
        }

        async function loadCases() {
            if (!dbConnected || !supabase) {
                loadCasesFromLocalStorage();
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('cases')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                cases = data.map(row => ({
                    id: row.permit_number,
                    permitNumber: row.permit_number,
                    clientName: row.client_name,
                    clientEmail: row.client_email,
                    clientPhone: row.client_phone,
                    address: row.address,
                    permitType: row.permit_type,
                    description: row.description,
                    status: row.status,
                    submissionDate: new Date(row.created_at).toLocaleDateString(),
                    planSet: row.plan_set_filename,
                    analysisResult: row.analysis_result,
                    documents: row.documents || [],
                    // Ensure revision_history is always an array of objects
                    revisionHistory: (row.revision_history || []).map(rev => ({
                        ...rev,
                        date: rev.date || new Date().toISOString(),
                        documents: rev.documents || []
                    }))
                }));
                
                console.log(`‚úÖ Loaded ${cases.length} cases from database`);
                
            } catch (error) {
                console.error('‚ùå Failed to load cases from database:', error);
                loadCasesFromLocalStorage();
            }
        }

        async function updateCaseStatus(permitNumber, newStatus, analysisResult = null) {
            if (!dbConnected || !supabase) {
                updateCaseStatusInLocalStorage(permitNumber, newStatus, analysisResult);
                return;
            }
            
            try {
                const caseToUpdate = cases.find(c => c.permitNumber === permitNumber || c.id === permitNumber);
                if (!caseToUpdate) {
                    console.error('Case not found for update:', permitNumber);
                    return;
                }

                const updateData = { 
                    status: newStatus,
                    updated_at: new Date().toISOString()
                };
                
                if (analysisResult) {
                    updateData.analysis_result = analysisResult;
                }
                
                let finalPermitNumber = permitNumber;
                // If approving, remove TEMP prefix
                if (newStatus === 'Approved') {
                    finalPermitNumber = permitNumber.replace('TEMP-', '');
                    updateData.permit_number = finalPermitNumber; // Update permit_number in DB
                }

                // Update revision history
                const newRevisionHistory = [...caseToUpdate.revisionHistory];
                let revisionEntry = {
                    date: new Date().toISOString(),
                    initiated_by: currentUserRole,
                    documents: []
                };

                if (newStatus === 'Under Review' && analysisResult) {
                    // This is when analysis starts/completes
                    revisionEntry.rev = `Rev. ${newRevisionHistory.length + 1}`;
                    revisionEntry.description = 'Under Review (when analysis starts)';
                    revisionEntry.documents.push(`AI_Analysis_Report_${finalPermitNumber}.pdf`);
                } else if (newStatus === 'Approved') {
                    revisionEntry.rev = `Rev. ${newRevisionHistory.length + 1}`;
                    revisionEntry.description = 'Approved (when approved)';
                    revisionEntry.documents.push(`APPROVED_SEALED_PLANS_${finalPermitNumber}.pdf`);
                } else if (newStatus === 'Corrections Needed') {
                     revisionEntry.rev = `Rev. ${newRevisionHistory.length + 1}`;
                     revisionEntry.description = 'Corrections Needed';
                     revisionEntry.documents.push(`Correction_Letter_${finalPermitNumber}.pdf`);
                }
                
                // Add new entry only if it's a distinct event
                const lastRev = newRevisionHistory[newRevisionHistory.length - 1];
                if (!lastRev || lastRev.description !== revisionEntry.description) {
                    newRevisionHistory.push(revisionEntry);
                    updateData.revision_history = newRevisionHistory;
                }

                const { data, error } = await supabase
                    .from('cases')
                    .update(updateData)
                    .eq('permit_number', permitNumber); // Use original permitNumber for the WHERE clause
                
                if (error) throw error;
                
                console.log(`‚úÖ Updated case ${permitNumber} status to ${newStatus}`);
                await loadCases(); // Reload all cases to get updated data
                
            } catch (error) {
                console.error('‚ùå Failed to update case status:', error);
                updateCaseStatusInLocalStorage(permitNumber, newStatus, analysisResult);
            }
        }

        // LocalStorage fallback functions
        function saveCaseToLocalStorage(caseData) {
            const localCases = JSON.parse(localStorage.getItem('globeCases')) || [];
            // Ensure revisionHistory is always an array of objects
            const revisionHistoryFormatted = (caseData.revisionHistory || []).map(rev => ({
                ...rev,
                date: rev.date || new Date().toISOString(),
                documents: rev.documents || []
            }));
            localCases.push({...caseData, revisionHistory: revisionHistoryFormatted});
            localStorage.setItem('globeCases', JSON.stringify(localCases));
            cases = localCases;
            console.log('üìÅ Case saved to localStorage');
        }

        function loadCasesFromLocalStorage() {
            cases = JSON.parse(localStorage.getItem('globeCases')) || [];
            // Ensure revisionHistory is always an array of objects for loaded cases
            cases = cases.map(c => ({
                ...c,
                revisionHistory: (c.revisionHistory || []).map(rev => ({
                    ...rev,
                    date: rev.date || new Date().toISOString(),
                    documents: rev.documents || []
                }))
            }));
            console.log(`üìÅ Loaded ${cases.length} cases from localStorage`);
        }

        function updateCaseStatusInLocalStorage(permitNumber, newStatus, analysisResult = null) {
            const localCases = JSON.parse(localStorage.getItem('globeCases')) || [];
            const caseIndex = localCases.findIndex(c => 
                c.permitNumber === permitNumber || c.id === permitNumber
            );
            
            if (caseIndex !== -1) {
                const caseToUpdate = localCases[caseIndex];
                caseToUpdate.status = newStatus;
                if (analysisResult) {
                    caseToUpdate.analysisResult = analysisResult;
                }

                // If approving, remove TEMP prefix
                if (newStatus === 'Approved') {
                    const finalPermitNumber = permitNumber.replace('TEMP-', '');
                    caseToUpdate.permitNumber = finalPermitNumber;
                    caseToUpdate.id = finalPermitNumber;
                }

                // Update revision history (same logic as Supabase update)
                const newRevisionHistory = [...caseToUpdate.revisionHistory];
                let revisionEntry = {
                    date: new Date().toISOString(),
                    initiated_by: currentUserRole,
                    documents: []
                };

                if (newStatus === 'Under Review' && analysisResult) {
                    revisionEntry.rev = `Rev. ${newRevisionHistory.length + 1}`;
                    revisionEntry.description = 'Under Review (when analysis starts)';
                    revisionEntry.documents.push(`AI_Analysis_Report_${caseToUpdate.permitNumber.replace('TEMP-', '')}.pdf`);
                } else if (newStatus === 'Approved') {
                    revisionEntry.rev = `Rev. ${newRevisionHistory.length + 1}`;
                    revisionEntry.description = 'Approved (when approved)';
                    revisionEntry.documents.push(`APPROVED_SEALED_PLANS_${caseToUpdate.permitNumber.replace('TEMP-', '')}.pdf`);
                } else if (newStatus === 'Corrections Needed') {
                     revisionEntry.rev = `Rev. ${newRevisionHistory.length + 1}`;
                     revisionEntry.description = 'Corrections Needed';
                     revisionEntry.documents.push(`Correction_Letter_${caseToUpdate.permitNumber.replace('TEMP-', '')}.pdf`);
                }
                
                const lastRev = newRevisionHistory[newRevisionHistory.length - 1];
                if (!lastRev || lastRev.description !== revisionEntry.description) {
                    newRevisionHistory.push(revisionEntry);
                    caseToUpdate.revisionHistory = newRevisionHistory;
                }

                localStorage.setItem('globeCases', JSON.stringify(localCases));
                cases = localCases; // Update global 'cases' array reference
                console.log(`üìÅ Updated case ${permitNumber} in localStorage`);
            }
        }

        // Application initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ GLOBE System initializing...');
            
            await initializeSupabase();
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('role').value;

                if ((username === 'admin' && password === 'admin' && role === 'admin') ||
                    (username === 'reviewer' && password === 'reviewer' && role === 'reviewer') ||
                    (username === 'supervisor' && password === 'supervisor' && role === 'supervisor')) {
                    
                    currentUser = username;
                    currentUserRole = role;
                    
                    // document.getElementById('currentUser').textContent = `${username} (${role})`; // This line is now effectively hidden by CSS
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    
                    updateDashboard();
                    
                    console.log('‚úÖ Login successful:', username, role);
                } else {
                    alert('Invalid credentials. Use demo credentials provided.');
                }
            });

            document.getElementById('caseSearch').addEventListener('input', function(e) {
                filterCases(e.target.value);
            });
        });

        function logout() {
            currentUser = null;
            currentUserRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        async function showTab(tabName) {
            ['dashboard', 'caseDetails', 'codeManagement', 'codexAgent'].forEach(tab => {
                document.getElementById(tab + 'Tab').classList.add('hidden');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const selectedTabElement = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
            if (selectedTabElement) {
                selectedTabElement.classList.add('active');
            }
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'codeManagement') {
                await loadCodeManagement(); // Load codes when Code Management tab is opened
            }
        }

        async function updateDashboard() {
            await loadCases();
            
            document.getElementById('totalCases').textContent = cases.length;
            document.getElementById('pendingCases').textContent = cases.filter(c => c.status === 'Pending Review').length;
            
            displayCases(cases);
        }

        function displayCases(casesToShow) {
            const caseList = document.getElementById('caseList');
            if (casesToShow.length === 0) {
                caseList.innerHTML = '<p style="text-align: center; color: black; padding: 2rem; font-size: 18px;">No cases found. Visit the <a href="new-case.html">client portal</a> to submit a case.</p>';
            } else {
                caseList.innerHTML = casesToShow.map(caseData => `
                    <div class="case-item" onclick="viewCase('${caseData.permitNumber || caseData.id}')">
                        <div class="case-id">${caseData.permitNumber || caseData.id}</div>
                        <div style="font-size: 16px; color: black; margin: 0.5rem 0;">${caseData.address} - ${caseData.description || 'No description'}</div>
                        <div class="case-status status-${(caseData.status || 'pending').replace(/\s/g, '').toLowerCase()}">${caseData.status || 'Pending Review'}</div>
                    </div>
                `).join('');
            }
        }

        function filterCases(searchTerm) {
            if (!searchTerm) {
                displayCases(cases);
                return;
            }
            
            const filtered = cases.filter(caseData => 
                (caseData.permitNumber || caseData.id || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                (caseData.clientName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                (caseData.address || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                (caseData.status || '').toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayCases(filtered);
        }

        function viewCase(caseId) {
            const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
            if (!caseData) {
                alert('Case not found');
                return;
            }
            
            currentCaseId = caseId;
            showTab('caseDetails');
            
            const detailsTab = document.getElementById('caseDetailsTab');
            detailsTab.innerHTML = `
                <div class="main-content">
                    <h2 style="font-size: 24px; color: black;">Case Details: ${caseData.permitNumber || caseData.id}</h2>
                    <div style="margin: 2rem 0;">
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Client:</strong> ${caseData.clientName || 'N/A'}</p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Email:</strong> ${caseData.clientEmail || 'N/A'}</p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Phone:</strong> ${caseData.clientPhone || 'N/A'}</p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Address:</strong> ${caseData.address || 'N/A'}</p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Type:</strong> ${caseData.permitType || 'N/A'}</p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Status:</strong> <span class="case-status status-${(caseData.status || 'pending').replace(/\s/g, '').toLowerCase()}">${caseData.status || 'Pending Review'}</span></p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Description:</strong> ${caseData.description || 'No description'}</p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Plan Set:</strong> ${caseData.planSet || 'No file uploaded'}</p>
                        <p style="margin: 0.7rem 0; font-size: 18px;"><strong>Submission Date:</strong> ${caseData.submissionDate || 'N/A'}</p>
                    </div>

                    <div style="margin-top: 2rem;">
                        <h3 style="font-size: 20px; color: black; margin-bottom: 1rem;">Revision History</h3>
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; max-height: 200px; overflow-y: auto;">
                            ${caseData.revisionHistory && caseData.revisionHistory.length > 0 ?
                                caseData.revisionHistory.map(rev => `
                                    <div style="margin-bottom: 0.7rem; padding-bottom: 0.7rem; border-bottom: 1px dashed #e0e0e0;">
                                        <strong>${rev.rev || `Rev. ${caseData.revisionHistory.indexOf(rev) + 1}`} - ${rev.description}</strong><br>
                                        Date: ${new Date(rev.date).toLocaleDateString()} | Initiated by: ${rev.initiated_by}<br>
                                        Documents: ${rev.documents && rev.documents.length > 0 ? rev.documents.join(', ') : 'No documents issued'}
                                    </div>
                                `).join('')
                                : '<p style="color: #6b7280;">No revision history yet.</p>'
                            }
                        </div>
                    </div>
                    
                    <div id="analysisContainer">
                        ${caseData.analysisResult && caseData.analysisResult !== 'Initial submission received' && caseData.analysisResult !== 'Initial submission received and validated. Ready for analysis.' ? `
                            <div class="analysis-result">
                                <h3 style="color: #0ea5e9; margin-bottom: 1rem; font-size: 20px;">AI Analysis Results</h3>
                                <div style="font-size: 16px; color: black;">${caseData.analysisResult}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-analyze" id="analyzeBtn" onclick="analyzeCase('${caseData.permitNumber || caseData.id}')" ${analysisInProgress ? 'disabled' : ''}>
                            ${analysisInProgress ? '<span class="spinner"></span> Analyzing...' : 'Analyze Case'}
                        </button>
                        <button class="btn btn-corrections" onclick="requestCorrections('${caseData.permitNumber || caseData.id}')" style="margin-left: 1rem;">Request Corrections</button>
                        <button class="btn btn-approve" onclick="approveCase('${caseData.permitNumber || caseData.id}')" style="margin-left: 1rem;">Approve</button>
                    </div>
                </div>
            `;
        }

        async function analyzeCase(caseId) {
            if (analysisInProgress) return;
            
            const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
            if (!caseData) return;

            analysisInProgress = true;
            analysisTimeRemaining = 5 * 60; // Reset timer to 5 minutes
            
            // Update button state
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="spinner"></span> Analyzing...';
            
            // Show loading animation
            const analysisContainer = document.getElementById('analysisContainer');
            analysisContainer.innerHTML = `
                <div class="analysis-loading">
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                        <span class="spinner"></span>
                        <h3 style="color: #059669; margin-left: 1rem;">CodeX AI Analysis in Progress</h3>
                    </div>
                    <div class="analysis-countdown" id="analysisCountdown">
                        ‚è±Ô∏è Estimated time: 5 minutes ‚Ä¢ High-precision analysis in progress
                    </div>
                    <div class="analysis-steps" id="analysisSteps">
                        <div class="analysis-step active" id="step1">üîç Scanning building plans...</div>
                        <div class="analysis-step" id="step2">üìã Checking structural compliance...</div>
                        <div class="analysis-step" id="step3">üî• Analyzing fire safety systems...</div>
                        <div class="analysis-step" id="step4">‚ö° Reviewing electrical codes...</div>
                        <div class="analysis-step" id="step5">üîß Validating plumbing systems...</div>
                        <div class="analysis-step" id="step6">üå°Ô∏è Checking HVAC compliance...</div>
                        <div class="analysis-step" id="step7">‚úÖ Generating compliance report...</div>
                    </div>
                </div>
            `;

            // Simulate 5-minute analysis with step progression
            const steps = [
                { id: 'step1', text: 'Scanning building plans...' },
                { id: 'step2', text: 'Checking structural compliance...' },
                { id: 'step3', text: 'Analyzing fire safety systems...' },
                { id: 'step4', text: 'Reviewing electrical codes...' },
                { id: 'step5', text: 'Validating plumbing systems...' },
                { id: 'step6', text: 'Checking HVAC compliance...' },
                { id: 'step7', text: 'Generating compliance report...' }
            ];
            let currentStepIndex = 0;

            // Timer update for countdown
            analysisTimerInterval = setInterval(() => {
                analysisTimeRemaining--;
                const minutes = Math.floor(analysisTimeRemaining / 60);
                const seconds = analysisTimeRemaining % 60;

                const countdownEl = document.getElementById('analysisCountdown');
                if (countdownEl) {
                    if (analysisTimeRemaining > 0) {
                        countdownEl.textContent = `‚è±Ô∏è Estimated time: ${minutes} minute${minutes !== 1 ? 's' : ''} ‚Ä¢ High-precision analysis in progress`;
                    } else {
                        countdownEl.textContent = `‚è±Ô∏è Analysis completing ‚Ä¢ Finalizing results...`;
                    }
                }

                if (analysisTimeRemaining <= 0) {
                    clearInterval(analysisTimerInterval);
                    completeAnalysis(caseId, caseData.permitType);
                }
            }, 1000); // Update every second for countdown

            // Step progression logic
            const advanceStep = () => {
                if (currentStepIndex < steps.length) {
                    // Deactivate previous step if any
                    if (currentStepIndex > 0) {
                        const prevStepEl = document.getElementById(steps[currentStepIndex - 1].id);
                        if (prevStepEl) prevStepEl.classList.remove('active');
                    }
                    // Activate current step
                    const currentStepEl = document.getElementById(steps[currentStepIndex].id);
                    if (currentStepEl) currentStepEl.classList.add('active');

                    currentStepIndex++;
                    // Schedule next step (distribute 5 minutes across steps)
                    if (currentStepIndex <= steps.length) {
                        setTimeout(advanceStep, (5 * 60 * 1000) / steps.length); // Total time / number of steps
                    }
                }
            };
            advanceStep(); // Start the first step immediately
        }

        async function completeAnalysis(caseId, permitType) {
            clearInterval(analysisTimerInterval); // Ensure interval is cleared
            analysisInProgress = false;

            const analysisResult = generatePermitSpecificAnalysis(permitType); // Pass permitType
            
            await updateCaseStatus(caseId, 'Under Review', analysisResult);
            
            // Refresh the case view to show results
            viewCase(caseId);
            
            alert('üîç AI Analysis Complete!\n\nCodeX has analyzed the plans and generated a detailed compliance report. Review the findings above and take appropriate action.');
        }

        async function approveCase(caseId) {
            if (confirm('Approve this case and generate sealed plans?')) {
                const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
                if (!caseData) return;

                try {
                    const approverName = currentUser;
                    const sealedPdfBytes = await generateSealedPDF(caseData, approverName);
                    
                    // Final permit number (remove TEMP prefix)
                    const originalPermitNumber = caseData.permitNumber;
                    const finalPermitNumber = originalPermitNumber.replace('TEMP-', '');
                    const fileName = `APPROVED_SEALED_PLANS_${finalPermitNumber}.pdf`;
                    
                    await downloadSealedPDF(sealedPdfBytes, fileName);
                    
                    await updateCaseStatus(originalPermitNumber, 'Approved'); // Use original ID for update, new ID is set inside

                    // Update the local cases array after a successful approval to reflect new permit number and status
                    const updatedCase = cases.find(c => c.id === finalPermitNumber);
                    if(updatedCase) {
                        viewCase(updatedCase.id); // View with new permit number
                    }
                    
                    const smsMessage = `Case ${finalPermitNumber} has been APPROVED! Your sealed plans are ready for download in the client portal.`;
                    
                    alert(`‚úÖ Case Approved Successfully!\n\nüìã Sealed plans generated: ${fileName}\nüì± SMS sent to ${caseData.clientPhone}:\n"${smsMessage}"\n\nüîó Client can download sealed plans from the client portal.\n\n‚úÖ Permit number updated: ${originalPermitNumber} ‚Üí ${finalPermitNumber}`);
                    
                    updateDashboard();
                    
                } catch (error) {
                    console.error('‚ùå Failed to approve case:', error);
                    alert('‚ùå Failed to generate sealed plans. Please try again.');
                }
            }
        }

        async function requestCorrections(caseId) {
            const caseData = cases.find(c => c.permitNumber === caseId || c.id === caseId);
            if (!caseData) return;

            // Check if AI analysis exists
            if (!caseData.analysisResult || 
                caseData.analysisResult === 'Initial submission received' || 
                caseData.analysisResult === 'Initial submission received and validated. Ready for analysis.') {
                alert('‚ö†Ô∏è Please run AI Analysis first before requesting corrections.\n\nThe AI analysis provides specific code violations and recommendations that will be sent to the client.');
                return;
            }

            if (confirm('Are you sure you want to send the AI Analysis Results to the client?\n\nThis will notify them of the specific corrections needed based on the CodeX analysis.')) {
                await updateCaseStatus(caseId, 'Corrections Needed');
                
                const smsMessage = `Case ${caseData.permitNumber} requires corrections. Please check the client portal for details.`;
                
                alert(`üìù AI Analysis Results Sent to Client!\n\nüì± SMS sent to ${caseData.clientPhone}:\n"${smsMessage}"\n\nüìß Email sent to ${caseData.clientEmail} with detailed correction requirements from CodeX analysis.\n\nüîó Client will submit revised plans through the client portal.`);
                
                updateDashboard();
                viewCase(caseId);
            }
        }

        // Codex Agent Functions
        let agentIsScanning = false;
        let agentProgress = 0;
        let agentCitiesScannedCount = 0; // Reset to 0
        let agentCodesFoundCount = 0; // Reset to 0
        let agentViolationsDetectedCount = 0; // Reset to 0

        function startAgentCodeDiscovery() {
            const cityName = document.getElementById('agentCityName').value;
            const stateCode = document.getElementById('agentStateCode').value;
            
            if (!cityName || !stateCode) {
                alert('Please fill in City/County Name and State to launch discovery!');
                return;
            }

            if (agentIsScanning) {
                addAgentLogEntry('warning', 'Agent is already scanning. Please wait or pause.');
                return;
            }

            agentIsScanning = true;
            agentProgress = 0;
            document.getElementById('agentCurrentOperation').textContent = `Scanning ${cityName}, ${stateCode}`;
            addAgentLogEntry('info', `Initiating code discovery for ${cityName}, ${stateCode}`);
            
            simulateAgentCodeDiscovery(cityName, stateCode);
        }

        async function simulateAgentCodeDiscovery(cityName, stateCode) {
            const steps = [
                { progress: 15, text: 'Connecting to Municode library...', log: 'Connected to 3,300+ municipal codes' },
                { progress: 30, text: 'Scanning city website...', log: `Found ${cityName} municipal website` },
                { progress: 50, text: 'Extracting PDF documents...', log: 'Processing 47 code documents' },
                { progress: 70, text: 'Parsing building codes...', log: 'Discovering new building codes...' },
                { progress: 85, text: 'Creating AI compliance rules...', log: 'Generating violation detection rules...' },
                { progress: 100, text: 'Code discovery complete!', log: `Successfully integrated ${cityName} codes into GLOBE` }
            ];
            let currentStep = 0;

            const processStep = async () => { // Made async to await Supabase inserts
                if (currentStep < steps.length && agentIsScanning) {
                    const step = steps[currentStep];
                    agentProgress = step.progress;

                    document.getElementById('agentProgressFill').style.width = agentProgress + '%';
                    document.getElementById('agentProgressText').textContent = step.text;
                    addAgentLogEntry('info', step.log);

                    if (step.progress === 100) {
                        // Simulate discovered codes and insert them into building_codes table
                        const newCodesCount = Math.floor(Math.random() * 5) + 1; // Discover 1-5 new codes
                        const newCodesToInsert = [];
                        for (let i = 0; i < newCodesCount; i++) {
                            const codeSection = `CODE-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`;
                            const codeName = `Discovered Code #${i+1} for ${cityName}`;
                            const codeDescription = `Automatically discovered rule from ${cityName} municipal code books.`;
                            newCodesToInsert.push({
                                code_section: codeSection,
                                name: codeName,
                                description: codeDescription,
                                status: 'pending_review' // Status for newly discovered codes
                            });
                        }

                        if (newCodesToInsert.length > 0 && supabase) {
                            try {
                                const { error: insertError } = await supabase
                                    .from('building_codes')
                                    .insert(newCodesToInsert);
                                if (insertError) throw insertError;
                                console.log(`‚úÖ Inserted ${newCodesToInsert.length} discovered codes into building_codes.`);
                            } catch (insertError) {
                                console.error('‚ùå Failed to insert discovered codes:', insertError);
                            }
                        }

                        // Update global stats
                        agentCitiesScannedCount++; 
                        agentCodesFoundCount += newCodesCount; // Add the number of new codes inserted
                        agentViolationsDetectedCount += newCodesCount * 3; // Simulate new violation rules
                        updateAgentStats();
                        agentIsScanning = false;
                        document.getElementById('agentCurrentOperation').textContent = 'Discovery Complete';
                        addAgentLogEntry('success', `Discovery for ${cityName}, ${stateCode} finished. Integrated ${newCodesToInsert.length} new codes. Total codes: ${agentCodesFoundCount}`);
                        await loadCodeManagement(); // Refresh the code management tab to show newly discovered codes
                    }

                    currentStep++;
                    setTimeout(processStep, 2000);
                } else if (!agentIsScanning && currentStep < steps.length) {
                    addAgentLogEntry('info', 'Agent operation suspended.');
                }
            };

            processStep();
        }

        function addAgentLogEntry(type, message) {
            const logContainer = document.getElementById('agentLogContainer');
            if (!logContainer) return;

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            const colors = {
                'info': '#2563eb',
                'success': '#059669',
                'warning': '#d97706',
                'error': '#dc2626'
            };
            logEntry.style.color = colors[type] || '#2563eb';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateAgentStats() {
            document.getElementById('agentCitiesScanned').textContent = agentCitiesScannedCount;
            document.getElementById('agentCodesFound').textContent = agentCodesFoundCount;
            document.getElementById('agentViolationsDetected').textContent = agentViolationsDetectedCount;
        }

        function pauseAgent() {
            if (agentIsScanning) {
                agentIsScanning = false;
                addAgentLogEntry('warning', 'Agent paused by user');
                document.getElementById('agentCurrentOperation').textContent = 'Paused';
            } else {
                addAgentLogEntry('info', 'Agent is not active to pause.');
            }
        }

        function exportAgentCodes() {
            addAgentLogEntry('info', 'Exporting discovered codes to GLOBE database...');
            setTimeout(() => {
                addAgentLogEntry('success', 'Code database exported successfully');
                alert('Code database exported as JSON file.');
            }, 1000);
        }

        function integrateDiscoveredCodes() {
            // The actual insertion now happens directly during simulateAgentCodeDiscovery
            // This button now serves as a confirmation/refresh for the Code Management tab
            addAgentLogEntry('info', 'Integrating codes into main GLOBE system...');
            setTimeout(async () => {
                addAgentLogEntry('success', 'All discovered codes integrated into GLOBE database');
                addAgentLogEntry('info', 'Code compliance rules activated');
                alert('Success! Discovered codes have been integrated into GLOBE. Check the Code Management tab to see all imported codes.');
                await loadCodeManagement(); // Refresh code management tab after integration
            }, 1500);
        }

        function updateAgentNow() {
            if (agentIsScanning) {
                addAgentLogEntry('warning', 'Agent is currently busy. Please wait or pause the current operation.');
                return;
            }
            addAgentLogEntry('info', 'Initiating manual code update check...');
            agentIsScanning = true;
            agentProgress = 0;
            document.getElementById('agentCurrentOperation').textContent = 'Checking for updates...';
            document.getElementById('agentProgressFill').style.width = '0%';
            document.getElementById('agentProgressText').textContent = 'Checking for updates...';

            setTimeout(async () => { // Made async to await DB operations
                agentProgress = 50;
                document.getElementById('agentProgressFill').style.width = '50%';
                document.getElementById('agentProgressText').textContent = 'Comparing against online sources...';
                addAgentLogEntry('info', 'Comparing current database with latest municipal code versions.');
            }, 1000);

            setTimeout(async () => { // Made async to await DB operations
                agentProgress = 100;
                document.getElementById('agentProgressFill').style.width = '100%';
                document.getElementById('agentCurrentOperation').textContent = 'Update Complete';
                agentIsScanning = false;

                const newCodesFound = Math.floor(Math.random() * 3);
                if (newCodesFound > 0) {
                    addAgentLogEntry('success', `Found ${newCodesFound} new or updated codes.`);
                    // Simulate inserting new/updated codes to building_codes
                    const updatedCodesToInsert = [];
                    for(let i = 0; i < newCodesFound; i++) {
                        const codeSection = `UPDATE-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`;
                        const codeName = `Updated Code #${i+1}`;
                        const codeDescription = `Updated rule from municipality.`;
                        updatedCodesToInsert.push({
                            code_section: codeSection,
                            name: codeName,
                            description: codeDescription,
                            status: 'pending_review' // New/updated codes go for review
                        });
                    }

                    if (updatedCodesToInsert.length > 0 && supabase) {
                        try {
                            const { error: insertError } = await supabase
                                .from('building_codes')
                                .insert(updatedCodesToInsert);
                            if (insertError) throw insertError;
                            console.log(`‚úÖ Inserted ${updatedCodesToInsert.length} updated codes into building_codes.`);
                            await loadCodeManagement(); // Refresh tab
                        } catch (insertError) {
                            console.error('‚ùå Failed to insert updated codes:', insertError);
                        }
                    }

                    agentCodesFoundCount += newCodesFound;
                    agentViolationsDetectedCount += newCodesFound * 3;
                    updateAgentStats();
                } else {
                    addAgentLogEntry('info', 'No new code updates found at this time.');
                }
                document.getElementById('agentProgressText').textContent = 'Update check complete.';
            }, 2500);
        }

        // Code Management Functions (now working with status column)
        let allBuildingCodes = []; // Stores all codes fetched from DB

        async function loadCodeManagement() {
            if (!dbConnected || !supabase) {
                displayPendingCodes([]);
                displayApprovedCodes([]);
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('building_codes')
                    .select('*')
                    .order('code_section', { ascending: true }); // Order by code section

                if (error) throw error;
                allBuildingCodes = data; // Store all codes

                const pending = allBuildingCodes.filter(code => code.status === 'pending_review');
                const approved = allBuildingCodes.filter(code => code.status === 'approved');

                displayPendingCodes(pending);
                displayApprovedCodes(approved);

            } catch (error) {
                console.error('‚ùå Failed to load codes for management:', error);
                displayPendingCodes([]);
                displayApprovedCodes([]);
            }
        }

        function displayPendingCodes(codes) {
            const listContainer = document.getElementById('pendingCodesList');
            const header = document.getElementById('pendingCodesHeader');
            listContainer.innerHTML = '';
            header.textContent = `üìã Pending Approval (${codes.length})`;

            if (codes.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">No codes pending approval.</p>';
                return;
            }

            codes.forEach(code => {
                const codeItem = document.createElement('div');
                codeItem.className = 'code-item';
                codeItem.innerHTML = `
                    <div class="code-info">
                        <div class="code-section-name">${code.code_section} - ${code.name || 'N/A'}</div>
                        <div class="code-description">${code.description || 'No description'}</div>
                    </div>
                    <div class="code-actions">
                        <button class="btn btn-approve btn-small" onclick="approveCode('${code.id}')">Approve</button>
                        <button class="btn btn-reject btn-small" onclick="rejectCode('${code.id}')">Reject</button>
                        <button class="btn btn-edit btn-small" onclick="editCode('${code.id}')">Edit</button>
                    </div>
                `;
                listContainer.appendChild(codeItem);
            });
        }

        function displayApprovedCodes(codes) {
            const listContainer = document.getElementById('approvedCodesList');
            const header = document.getElementById('approvedCodesHeader');
            listContainer.innerHTML = '';
            header.textContent = `‚úÖ Approved Codes (${codes.length})`;

            if (codes.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">No approved codes found.</p>';
                return;
            }

            codes.forEach(code => {
                const codeItem = document.createElement('div');
                codeItem.className = 'code-item';
                codeItem.innerHTML = `
                    <div class="code-info">
                        <div class="code-section-name">${code.code_section} - ${code.name || 'N/A'}</div>
                        <div class="code-description">${code.description || 'No description'}</div>
                    </div>
                    <div class="code-actions">
                        <button class="btn btn-edit btn-small" onclick="editCode('${code.id}')">Edit</button>
                    </div>
                `;
                listContainer.appendChild(codeItem);
            });
        }

        async function approveCode(codeId) {
            if (!dbConnected || !supabase) { alert('Database not connected. Cannot perform action.'); return; }
            if (confirm('Are you sure you want to approve this code? It will be used for compliance analysis.')) {
                try {
                    const { error } = await supabase
                        .from('building_codes')
                        .update({ status: 'approved', updated_at: new Date().toISOString() })
                        .eq('id', codeId);
                    if (error) throw error;
                    alert('Code approved successfully!');
                    loadCodeManagement(); // Refresh the list
                } catch (error) {
                    console.error('Error approving code:', error);
                    alert('Failed to approve code: ' + error.message);
                }
            }
        }

        async function rejectCode(codeId) {
            if (!dbConnected || !supabase) { alert('Database not connected. Cannot perform action.'); return; }
            if (confirm('Are you sure you want to reject this code? It will be marked as rejected and not used for analysis.')) {
                try {
                    const { error } = await supabase
                        .from('building_codes')
                        .update({ status: 'rejected', updated_at: new Date().toISOString() })
                        .eq('id', codeId);
                    if (error) throw error;
                    alert('Code rejected.');
                    loadCodeManagement(); // Refresh the list
                } catch (error) {
                    console.error('Error rejecting code:', error);
                    alert('Failed to reject code: ' + error.message);
                }
            }
        }

        async function editCode(codeId) {
            if (!dbConnected || !supabase) { alert('Database not connected. Cannot perform action.'); return; }
            const codeToEdit = allBuildingCodes.find(c => c.id === codeId); // Find from all fetched codes
            if (!codeToEdit) { alert('Code not found.'); return; }

            const newCodeSection = prompt('Edit code section (e.g., NEC 110.26):', codeToEdit.code_section);
            if (newCodeSection === null) return; // User cancelled

            const newCodeName = prompt('Edit code name:', codeToEdit.name);
            if (newCodeName === null) return; // User cancelled

            const newDescription = prompt('Edit description:', codeToEdit.description);
            if (newDescription === null) return; // User cancelled
            
            try {
                const { error } = await supabase
                    .from('building_codes')
                    .update({ 
                        code_section: newCodeSection.trim(), 
                        name: newCodeName.trim(),
                        description: newDescription.trim(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', codeId);
                if (error) throw error;
                alert('Code updated successfully!');
                loadCodeManagement(); // Refresh the list
            } catch (error) {
                console.error('Error updating code:', error);
                alert('Failed to update code: ' + error.message);
            }
        }

        async function approveAllCodes() {
            if (!dbConnected || !supabase) { alert('Database not connected. Cannot perform action.'); return; }
            const pending = allBuildingCodes.filter(code => code.status === 'pending_review');
            if (pending.length === 0) {
                alert('No codes currently pending approval.');
                return;
            }
            if (confirm(`Approve all ${pending.length} pending codes? This will integrate them into the active code database.`)) {
                try {
                    const pendingIds = pending.map(code => code.id);
                    const { error } = await supabase
                        .from('building_codes')
                        .update({ status: 'approved', updated_at: new Date().toISOString() })
                        .in('id', pendingIds);
                    if (error) throw error;
                    alert(`‚úÖ All ${pending.length} pending codes approved and integrated into GLOBE database.`);
                    loadCodeManagement(); // Refresh the lists
                } catch (error) {
                    console.error('Error approving all codes:', error);
                    alert('Failed to approve all codes: ' + error.message);
                }
            }
        }

        async function rejectAllCodes() {
            if (!dbConnected || !supabase) { alert('Database not connected. Cannot perform action.'); return; }
            const pending = allBuildingCodes.filter(code => code.status === 'pending_review');
            if (pending.length === 0) {
                alert('No codes currently pending approval.');
                return;
            }
            if (confirm(`Reject all ${pending.length} pending codes? This will mark them as rejected and not used for analysis.`)) {
                try {
                    const pendingIds = pending.map(code => code.id);
                    const { error } = await supabase
                        .from('building_codes')
                        .update({ status: 'rejected', updated_at: new Date().toISOString() })
                        .in('id', pendingIds);
                    if (error) throw error;
                    alert(`‚ùå All ${pending.length} pending codes rejected.`);
                    loadCodeManagement(); // Refresh the lists
                } catch (error) {
                    console.error('Error rejecting all codes:', error);
                    alert('Failed to reject all codes: ' + error.message);
                }
            }
        }

        async function addNewCode() {
            if (!dbConnected || !supabase) { alert('Database not connected. Cannot perform action.'); return; }
            const codeSection = prompt('Enter code section (e.g., NEC 110.26):');
            if (!codeSection) return;
            const codeName = prompt('Enter code name (e.g., Electrical Panel Clearance):');
            if (!codeName) return;
            const codeDescription = prompt('Enter code description:');
            if (!codeDescription) return;

            try {
                const { data, error } = await supabase
                    .from('building_codes')
                    .insert([{ 
                        code_section: codeSection.trim(), 
                        name: codeName.trim(),
                        description: codeDescription.trim(), 
                        status: 'pending_review' // New codes manually added also go to pending approval
                    }]);
                if (error) throw error;
                alert(`‚úÖ New code "${codeSection}" added to pending approval!`);
                loadCodeManagement(); // Refresh the lists
            } catch (error) {
                console.error('Error adding new code:', error);
                alert('Failed to add new code: ' + error.message);
            }
        }

        function filterCodes() {
            const searchTerm = document.getElementById('codeSearch').value.toLowerCase();
            const filteredCodes = allBuildingCodes.filter(code => 
                code.status === 'approved' && // Only filter approved codes
                ((code.code_section && code.code_section.toLowerCase().includes(searchTerm)) ||
                (code.name && code.name.toLowerCase().includes(searchTerm)) ||
                (code.description && code.description.toLowerCase().includes(searchTerm)))
            );
            displayApprovedCodes(filteredCodes); // Display filtered list
        }

        // Expose functions globally
        window.logout = logout;
        window.showTab = showTab;
        window.viewCase = viewCase;
        window.analyzeCase = analyzeCase;
        window.approveCase = approveCase;
        window.requestCorrections = requestCorrections;
        window.startAgentCodeDiscovery = startAgentCodeDiscovery;
        window.pauseAgent = pauseAgent;
        window.exportAgentCodes = exportAgentCodes;
        window.integrateDiscoveredCodes = integrateDiscoveredCodes;
        window.updateAgentNow = updateAgentNow;
        window.approveAllCodes = approveAllCodes;
        window.rejectAllCodes = rejectAllCodes;
        window.addNewCode = addNewCode;
        window.filterCodes = filterCodes;
        window.approveCode = approveCode; // Expose for individual code approval
        window.rejectCode = rejectCode; // Expose for individual code rejection
        window.editCode = editCode; // Expose for individual code editing
        window.saveCase = saveCase; // Make sure this is exposed for client portal interaction
        
        console.log('‚úÖ GLOBE System Initialized Successfully');
        console.log('üî• PDF Sealing System Ready');
        console.log('ü§ñ AI Analysis System Ready');
        console.log('üöÄ All core functionality working');
    </script>
</body>
</html>
